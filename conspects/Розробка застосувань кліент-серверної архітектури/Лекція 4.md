# Тема 4 WCF як зручна технологія створення розподілених додатків. Основний принцип роботи

## Технологія WCF

`WCF` – це середовище виконання й набір ``API``-Інтерфейсів для створення систем, які забезпечують обмін повідомленнями між службами й клієнтами. Ті ж інфраструктура й інтерфейси ``API`` використовуються для створення додатків, що обмінюються даними з іншими додатками на даному комп'ютері або на комп'ютері, що перебуває в іншій компанії, і доступ до якого можна одержати через Інтернет.

В основі `Windows Communication Foundation` лежить `SOA` (Service Oriented Architecture) - сервіс-орієнтована архітектура. Ідея `SOA` полягає в тому, що на сервері працює деяка кількість сервісів, що надають доступ до якоїсь інформації й що дозволяють оперувати нею. Клієнти у свою чергу мають на своєму боці класи-проксі, які містять посилання на відповідні операції на стороні сервісу. Таким чином, викликаючи локально методи класу-проксі, відбувається вилучений виклик методу на сервісі. Фізична взаємодія між клієнтом і сервісом, як правило, відбувається шляхом обміну повідомленнями (наприклад, у форматі `SOAP`) між ними. Клієнт може одержати опис сервісу, використовуючи, наприклад, `WSDL` або `MEX`.

В основі функціонування `Windows Communication Foundation` лежать так звані кінцеві крапки (endpoint), які становить зв'язування "Address - Binding - Contract", "ABC". Кожна складова відіграє важливу роль у визначенні кінцевої крапки. Компонента "Address" містить місце розташування кінцевої крапки. Адреса може бути як абсолютною, так і відносною (щодо базової адреси). Компонента "Binding" задає прив'язку й, фактично, визначає транспорт, на основі якого буде відбуватися взаємодія. В об'єктній моделі Windows Communication Foundation уже визначений ряд класів-прив'язок, наприклад, BasicHttpBinding (проста прив'язка на основі HTTP), NetTcpBinding (прив'язка на основі транспорту TCP ) і т.д. Ну й, нарешті, компонента "Contract" задає контракт, на основі якого буде відбуватися взаємодія клієнта й сервісу. Фактично, визначення контракту регламентує, які операції "уміє" виконувати сервіс. На основі контракту будується клас-проксі на клієнті.

Як правило, на сервісній стороні задається безліч кінцевих крапок. Так, для того самого контракту можуть бути задані кілька кінцевих крапок (наприклад, для прив'язок BasicHttp і NetTcp). Крім того, ви можете розмістити кілька сервісів на сервісній стороні. У підсумку, сервісна сторона розподіленого додатка буде виглядати як сукупність кінцевих крапок. Клієнт у цьому випадку створює з'єднання з тією кінцевою крапкою, що потрібна саме йому. 

## Обмін повідомленнями й кінцеві крапки

В основі `WCF` лежить принцип зв'язку за допомогою обміну повідомленнями, і будь-які об'єкти, що моделюються у вигляді повідомлень (наприклад, `HTTP`-Запит або повідомлення черги повідомлень, `MSMQ`), можна представити єдиним чином у моделі програмування. Це забезпечує універсальний інтерфейс ``API`` для різних транспортних механізмів.

У моделі розрізняються клієнти, що є додатками, які ініціюють зв'язок, і служби, що є додатками, які очікують зв'язку клієнтів з ними й відповідають їм. Один додаток може бути як клієнтом, так і службою. 

Між кінцевими крапками виконується обмін повідомленнями. Кінцеві крапки - це місця, де відправляються або приймаються повідомлення й де визначаються всі відомості, необхідні для обміну повідомленнями. Служба надає одну або кілька кінцевих крапок додатка (а також нуль або більше кінцевих крапок інфраструктури), а клієнт створює кінцеву крапку, сумісну з однієї з кінцевих крапок служби.

Кінцева крапка стандартним способом описує місце відправлення повідомлень, спосіб відправлення повідомлень і вид повідомлень. Служба може надавати цю інформацію у вигляді метаданних, які клієнти можуть обробляти для створення відповідних клієнтів `WCF` і стеков зв'язку.

## Протоколи зв'язку

Одним з обов'язкових елементів зв'язку є транспортний протокол. Повідомлення можна відправляти через Інтернет за допомогою загальних транспортів, таких як `HTTP` і `TCP`. Передбачено інші транспорти, що підтримують зв'язок з додатками черги повідомлень і вузлами в сітці однорангової мережі. За допомогою убудованих крапок розширення `WCF` можна додати додаткові транспортні механізми.

Іншим обов'язковим елементом у стеці зв'язку є кодування, що визначає спосіб форматування будь-якого заданого повідомлення. Служба `WCF` надає наступні кодування:
- кодування тексту — кодування з можливістю взаємодії;
- кодування підсистеми оптимізації передачі повідомлень `MTOM` - підтримуюча взаємодія спосіб ефективного відправлення неструктурованих двійкових даних у службу й з неї;
- двійкове кодування для ефективної передачі. 

Додаткові механізми кодування (наприклад, кодування стиском) можна додати за допомогою убудованих крапок розширення `WCF`.

## Шаблони повідомлень

Служба `WCF` підтримує кілька шаблонів обміну повідомленнями, включаючи запит-відповідь, однобічний і дуплексний зв'язок. Різні транспорти підтримують різні шаблони обміну повідомленнями й у такий спосіб впливають на типи підтримуваних взаємодій. Інтерфейси ``API`` і середовище виконання `WCF` також допомагають відправляти повідомлення безпечно й швидко.

## Контракти й описи
Контракти визначають різні аспекти системи повідомлень. Контракти даних описують кожний параметр, що становить кожне повідомлення, що може бути створено або використано службою. Параметри повідомлення визначені документами мови визначення схеми `XML` (`XSD`), тим самим дозволяючи обробляти документи будь-якої системи, що сприймає `XML`. Контракт повідомлення визначає конкретні частини повідомлення, що використовують протокол `SOAP`, і дозволяє більш точно управляти частинами повідомлення, коли така точність потрібна при взаємодії. Контракт служби задає фактичні підписи методів служби й поширюється як інтерфейс в одній з підтримуваних мов програмування, наприклад `VisualBasic` і `Visual C#`. 

Політики й прив'язки задають умови, необхідні для взаємодії зі службою. Наприклад, прив'язка повинна (як мінімум) указувати використовуваний транспорт (наприклад, HTTP або TCP) і кодування. Політики містять вимоги до безпеки й інші умови, які повинні бути задоволені для взаємодії зі службою.

## Середовище виконання служби

Рівень середовища виконання служби містить поводження, що виникають тільки в процесі виконання самої операції служби, тобто поводження середовища виконання служби. Регулювання управляє кількістю оброблюваних повідомлень, що може змінюватися, якщо запити до служби зростають до заздалегідь установленої межі. Поводження при помилці вказує, що відбувається при виникненні внутрішньої помилки в службі, наприклад управляючи тим, яка інформація передається клієнтові. (Занадто багато відомостей можуть допомогти зловмисникові в здійсненні атаки.) Поводження метаданих управляє тим, чи будуть метадані доступні зовнішньому світу і як це зробити. Поводження екземпляра вказує, яке число екземплярів служби може виконатись (наприклад, одноелементний задає один екземпляр для обробки всіх повідомлень). Поводження транзакції включає відкіт транзакційних операцій при збої. Поводження диспетчера управляє обробкою повідомлення інфраструктурою `WCF`.

Розширюваність дозволяє набудовувати процеси середовища виконання. Наприклад, інспекція повідомлень надає можливість інспектувати частини повідомлень, а фільтрація параметрів дозволяє виконувати заздалегідь установлені дії, що виникають залежно від застосування фільтрів до заголовків повідомлень.

## Обмін повідомленнями

Рівень обміну повідомленнями складається з каналів. Канал - це компонент, що обробляє повідомлення деяким чином, наприклад шляхом перевірки дійсності повідомлення. Набір каналів називається стеком каналів. Канали оперують повідомленнями і їхніми заголовками. Це відрізняється від рівня середовища виконання служб, що, головним чином, займається обробкою вмісту тіл повідомлень.

Існує два типи каналів: канали транспорту й канали протоколів. 

Канали транспорту зчитують і записують повідомлення по мережі (або якій-небудь іншій крапці зв'язку із зовнішнім миром). Деякі транспорти використовують кодувальник для перетворення повідомлень (які представлені у вигляді наборів відомостей XML) у подання потоку байтів, використовуване в мережі, і назад. Прикладами транспортів є HTTP, іменовані канали, TCP і MSMQ. Прикладами кодування є XML і оптимізований двійковий тип.

Канали протоколів реалізують протоколи обробки повідомлень, звичайно при читанні або записі додаткових заголовків у повідомлення. Прикладами таких протоколів є WS-Security і WS-Reliability.

Рівень обміну повідомленнями демонструє можливі формати даних і їхні шаблони обміну. WS-Security є реалізацією специфікації WS-Security, що включає безпека на рівні обміну повідомленнями. Канал обміну повідомленнями WS-Reliable забезпечує гарантовану доставку повідомлень. Кодувальники надають різні кодування, які можуть використовуватися відповідно до потреб повідомлень. Канал HTTP указує, що протокол транспортування гіпертексту (HyperTextTransportProtocol) використовується для доставки повідомлень. У такий же спосіб канал TCP задає протокол TCP. Канал потоку транзакцій управляє шаблонами повідомлень транзакцій. Іменований канал включає міжпроцесну взаємодію Канал `MSMQ` взаємодія з додатками MSMQ.

## Розміщення й активація
 
У своїй кінцевій формі служба є програмою. Як і інші програми, служба повинна виконуватися у виконуючому файлі. Це називається резидентною службою. 

Також служби можуть розміщатися або виконуватися у виконуючому файлі, що управляється зовнішнім агентом, наприклад IIS або службою активації Windows (WAS). WAS дозволяє додаткам `WCF` автоматично проходити активацію при розробці на комп'ютері із установленою службою WAS. Службами також можуть бути вручну запущені файли, що виконуються як ( EXE-Файли). Їх також можна автоматично запускати у вигляді служб Windows. Компоненти COM+ можуть розміщатися також, як і служби `WCF`.